#!/usr/bin/env bash

# === Запуск NetworkManager через pkexec, если не активен ===
if ! systemctl is-active --quiet NetworkManager; then
    pkexec systemctl start NetworkManager
fi

# === Интерфейс Wi-Fi ===
wifi_iface="wlan0"  # обновлено на wlan0

# === Сохранённые Wi-Fi подключения (только 802-11-wireless) ===
saved_connections=$(nmcli -t -f NAME,TYPE connection show | grep '802-11-wireless' | cut -d: -f1)

# === Доступные сети Wi-Fi через интерфейс ===
available_networks=$(nmcli --fields "SECURITY,SSID" device wifi list ifname $wifi_iface | sed 1d \
    | sed 's/  */ /g' \
    | sed -E "s/WPA*.?\S/ /g" \
    | sed "s/^--/ /g" \
    | sed "s/  //g" \
    | sed "/--/d" \
    | sed '/^$/d' \
    | sed 's/^[ \t]*//;s/[ \t]*$//')

# === Формируем список для rofi: сначала сохранённые сети со значком  ===
wifi_list=""
while read -r ssid; do
    wifi_list+="   $ssid"$'\n'
done <<< "$saved_connections"

while read -r net; do
    clean_ssid=$(echo "$net" | sed 's/^[ ]*//')
    if ! echo "$saved_connections" | grep -Fxq "$clean_ssid"; then
        wifi_list+="$net"$'\n'
    fi
done <<< "$available_networks"

# === Текущая сеть ===
current_ssid=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d':' -f2)

# === Формируем массив опций для rofi ===
options=()
while IFS= read -r net; do
    [ -n "$net" ] && options+=("$net")
done <<< "$wifi_list"

# Добавляем кнопку Disconnect в начало списка
if [ -n "$current_ssid" ]; then
    options=("   Disconnect ($current_ssid)" "${options[@]}")
else
    options=("   Disconnect" "${options[@]}")
fi

# === Запуск rofi ===
chosen_network=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -selected-row 0 -p "Wi-Fi SSID:")
chosen_id=$(echo "$chosen_network" | sed 's/^[ ]*//' | xargs)  # убираем лишние символы и пробелы

# === Если ничего не выбрано ===
[ -z "$chosen_network" ] && exit 0

# === Если выбрали Disconnect ===
if [[ "$chosen_network" =~ "Disconnect" ]]; then
    nmcli device disconnect $wifi_iface
    notify-send "Wi-Fi disconnected"
    exit 0
fi

# === Подключение к сети ===
success_message="You are now connected to \"$chosen_id\"."
nmcli device set $wifi_iface managed yes

if echo "$saved_connections" | grep -wq "$chosen_id"; then
    nmcli connection up id "$chosen_id" && notify-send "Connected" "$success_message"
elif [[ "$chosen_network" =~ "" ]]; then
    wifi_password=$(rofi -dmenu -p "Password: ")
    nmcli device wifi connect "$chosen_id" password "$wifi_password" && notify-send "Connected" "$success_message"
else
    nmcli device wifi connect "$chosen_id" && notify-send "Connected" "$success_message"
fi
